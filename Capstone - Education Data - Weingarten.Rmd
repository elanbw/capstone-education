---
title: "HarvardX PH125.9x Capstone Project - Education Data"
author: "Elan Weingarten"
date: "`r Sys.Date()`"
output: 
  pdf_document
---

# I. Introduction

Topic: Are Title I schools more likely to see increases in % White students and decreases in % Black or Hispanic students?

This study investigates the relationship between Title I status and longitudinal shifts in racial composition at the school level. We find that Title I schools are disproportionately likely to experience decreases in the percentage of Black and Hispanic students and increases in White enrollment. Using regression and machine learning methods, we predict demographic change at the school level and explore patterns at state and district scales to inform equity-driven education policy.

Background:
Title I Funding is ... used a metric for...
Race is used because ...

#II. Methods

We gathered data from the **National Center for Education Statistics (NCES)** using their **Elementary and Secondary Information System (ELSi)** web application to create and download custom tables of education statistics.

We collected data on enrollment, race, etc. 
Each data point, or row, represents a single school in a single school year.

To make this data analyzable, we split all markers (such as race, Title I funding, etc.) into separate columns with a value of 1 or -1 to signify whether it applies to that school in that particular school year. Race and gender were transformed into percentages of the total student enrollment.

Each school year is simplified into a single year, for example the 2023-24 school year is represented as 2024. This concise style of writing the year is used for numeric calculations, and reduces the size of text in visual representations. Thus, it is used throughout this report.

We removed the following from our dataset:

* **School with less than 50 students**: EXPLAIN
* **The *Magnet School Flag* column**: Fewer than 25% of data points had a null value (not 1 or -1, but NA), so it was removed
* etc. [IMPLEMENT THIS!]
* etc.

We found the resulting clean to contain
X rows and column
represetnt x schools and x districts across all states and DC
Among all data points, ## of them have demographic data for students and for title i funding

With this data was bisualized and employed LM to.....

The following process was used to process the data:

```{r setup, message = FALSE, warning = FALSE}
library(tidyverse)
library(knitr)
library(ggplot2)
library(scales)
library(lme4)
library(broom.mixed)
library(kableExtra)
library(ggeffects)
```

```{r methods-load-data, message = FALSE, warning = FALSE}
data_dir = file.path(".", "data")

#data is split into four datasets since ELSi can only output 75 columns at a time
get_elsi_data = function (filename) {
  zip_filename = paste0(filename, ".zip")
  zip_path = file.path(data_dir, zip_filename)
  
  ed_data_filename = paste0(filename, ".csv")
  ed_data_path = file.path(data_dir, ed_data_filename)
  
  if (!file.exists(ed_data_path)) unzip(zip_path, exdir = data_dir)
  read_csv(ed_data_path, skip = 5)
}



filenames = c("1 ElSi School Info",
              "2 ElSi Characteristics",
              "3 ElSi Race",
              "4 ElSi Teacher and Race")

raw_data = lapply(filenames, get_elsi_data)

kable(
  sapply(raw_data, dim) %>% 
    `rownames<-`(c("Rows", "Columns")) %>% 
    `colnames<-`(filenames),
  caption = "Raw education data loaded with the following dimensions"
)
```

```{r methods-clean-data, message = FALSE, warning = FALSE}
make_clean_data = function (raw_data) {
  raw_data %>%
    rename( #easier names to work with
      school_name = `School Name`,
      state = `State Name [Public School] Latest available year`,
      full_id = `School ID (12-digit) - NCES Assigned [Public School] Latest available year`
    ) %>%
     # Restructure to turn school year from column name into a separate column
    pivot_longer(
      cols = -c(school_name, state, full_id) & !contains("Latest available year"),
      values_to = "value",
      names_to = "metric"
      ) %>%
    mutate(  #splits at the last space before the school year
      year = as.numeric(paste0("20", str_sub(metric, nchar(metric) - 1))),
      metric = str_sub(metric, 1, nchar(metric) - 8)
      ) %>%
    pivot_wider(
      names_from = metric,
      values_from = value
    )
}

clean_data = lapply(raw_data, make_clean_data)

#combine all four datasets into one big one
combined = clean_data[[1]] %>%
  left_join(select(clean_data[[2]], -c(school_name, state)), by = c("full_id", "year")) %>%
  left_join(select(clean_data[[3]], -c(school_name, state)), by = c("full_id", "year")) %>%
  left_join(select(clean_data[[4]], -c(school_name, state)), by = c("full_id", "year")) %>%
  rename_with(~ .x %>% #clean up column names
    str_remove_all("\\s\\[(District|Public School)\\]|\\.| Latest available year| [-–—] NCES Assigned") %>%  # remove [District] or [Public School]
    str_trim() %>%                                         # remove leading/trailing spaces
    str_replace_all("[ /\\-–]", "_") %>%                      # replace space, /, -, or – with _
    str_to_lower() %>%                                         # make all lower case
    str_replace_all("agency", "district") %>%              # replace agency with district
    str_replace_all("\\(sy_2017_18_onward\\)", "2018_onward") %>% #replace note about sy so that all parentheticals can be removed
    str_remove_all("_\\([^\\)]*\\)")                         # remove all parentheticals
  ) %>%
  mutate( #merge school level (since changed after 2018)
    school_level = str_replace(str_replace(str_replace(
      str_replace(school_level, "1-Primary", "Elementary"),
      "2-Middle", "Middle"),
      "3-High", "High"),
      "4-Other", "Other")
  ) %>%
  mutate(
    school_level = if_else(is.na(school_level), school_level_2018_onward, school_level)
    ) %>%
  select(-school_level_2018_onward) %>%
  # Replace missing data with NA
  mutate(across(everything(), ~ ifelse(. %in% c("†", "–", "‡"), NA, .))) %>%
  filter( # remove all rows where there is no meaningful data
  !if_all(
    -c(school_name, state, full_id, district_id, year),
    ~ is.na(.)
    )
  ) %>%
  # guess type of data
  type.convert(as.is = TRUE) 

# Make tidy by converting flags to boolean, and spreading columns with multiple
# possible values into individual columns with 1/-1 values.

flag_to_boolean = function(column) {
  case_when(
    column == "1-Yes" ~ TRUE,
    column == "2-No" ~ FALSE,
    TRUE ~ NA
  )
}

tidy_data = combined %>%
  mutate(
    # convert flags into boolean columns
    magnet_school = flag_to_boolean(magnet_school),
    charter_school = flag_to_boolean(charter_school),
    reconstituted_school = flag_to_boolean(reconstituted_flag),
    title_i = case_when(
      grepl("6-Not", title_i_school_status) ~ FALSE,
      is.na(title_i_school_status) ~ NA,
      TRUE ~ TRUE
    ),
    #recode options to simple terms
    #only keep the categories we plan to investigate
    school_type = case_when(
      grepl("Regular", school_type) ~ "school_type_regular",
      grepl("Special", school_type) ~ "school_type_sped",
      TRUE ~ NA
    ),
    district_type = case_when( 
      grepl("local", district_type, ignore.case = TRUE) ~ "district_type_regular",
      grepl("agency", district_type) ~ "district_type_gov_run",
      grepl("Charter", district_type) ~ "district_type_charter",
      TRUE ~ NA
    ),
    status = case_when(
      grepl("Open", start_of_year_status) ~ "status_open",
      grepl("New", start_of_year_status) ~ "status_new",
      grepl("Changed", start_of_year_status) ~ "status_moved",
      grepl("Reopened", start_of_year_status) ~ "status_reopened",
      TRUE ~ NA
    ),
    school_level = case_when(
      school_level == "Elementary" ~ "school_level_es",
      school_level == "High" ~ "school_level_hs",
      school_level == "Middle" ~ "school_level_ms",
      school_level == "Secondary" ~ "school_level_ms|school_level_hs",
      TRUE ~ NA
    )
  ) %>%
  select(-c(reconstituted_flag, start_of_year_status, title_i_school_status, school_id))
  
# Create a widened version for each column and reduce into a single data frame
ed_data_full = tidy_data %>%
  separate_rows(school_level, sep = "\\|") %>%
  
  # Create school_type columns
  filter(!is.na(school_type)) %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = school_type, values_from = value, values_fill = -1) %>%
  
  # Create district_type columns
  filter(!is.na(district_type)) %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = district_type, values_from = value, values_fill = -1) %>%
  
  # Create status columns
  filter(!is.na(status)) %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = status, values_from = value, values_fill = -1) %>%
  
  # Create school_level columns
  filter(!is.na(school_level)) %>%
  mutate(value = 1) %>%
  pivot_wider(names_from = school_level, values_from = value, values_fill = -1) %>%
  
  #turn demographics into percentages
  mutate(
    race_aian = american_indian_alaska_native_students/total_race_ethnicity,
    race_aapi = asian_or_asian_pacific_islander_students/total_race_ethnicity,
    race_hispanic = hispanic_students/total_race_ethnicity,
    race_black = black_or_african_american_students/total_race_ethnicity,
    race_white = white_students/total_race_ethnicity,
    race_nhpi = nat_hawaiian_or_other_pacific_isl_students/total_race_ethnicity,
    race_multi = two_or_more_races_students/total_race_ethnicity
  ) %>%
  select(-c(american_indian_alaska_native_students, 
            asian_or_asian_pacific_islander_students,
            hispanic_students,
            black_or_african_american_students,
            white_students,
            nat_hawaiian_or_other_pacific_isl_students,
            two_or_more_races_students,
            total_race_ethnicity
            )) %>%
  
  #turn genders into percentages
  mutate(
    total_gender = male_students + female_students,
    gender_male = male_students/total_gender,
    gender_female = female_students/total_gender
  ) %>%
  select(-c(total_gender, male_students, female_students)) %>%
  filter(total_students_all_grades > 50)
      
        
kable(
  as.data.frame(t(dim(ed_data_full))) %>%
    `colnames<-`(c("Rows", "Columns")),
  caption = "Clean data is created with the following dimensions"
)
```

## Description of all variables used

```{r methods-describe-dataset, echo = FALSE}
  
# Describe each variable
column_info = tribble(
  ~Column, ~Type, ~Description,
  "school_name", "character", "Name of the school",
  "state", "character", "U.S. state where the school is located",
  "full_id", "character", "Full NCES-assigned 12-digit school ID",
  "district_id", "character", "NCES-assigned district identifier",
  "year", "character", "Simplified school year (e.g., 2024 for the 2023–24 school year)",
  "district_name", "character", "Name of the school district",
  "county_name", "character", "County where the school is located",
  "county_number", "character", "County FIPS or internal number",
  "magnet_school", "logical", "TRUE if school is a magnet school, FALSE if not, NA if unknown",
  "charter_school", "logical", "TRUE if school is a charter school, FALSE if not, NA if unknown",
  "total_students_all_grades", "numeric", "Total student enrollment across all grades",
  "full_time_equivalent_teachers", "numeric", "FTE count of teachers",
  "pupil_teacher_ratio", "numeric", "Ratio of students to teachers",
  "reconstituted_school", "logical", "TRUE if school was reconstituted, FALSE if not, NA if unknown",
  "title_i", "logical", "TRUE if school has any Title I program, FALSE if explicitly excluded, NA if unknown",
  "school_type_regular", "integer", "1 if the school is regular type, -1 otherwise",
  "school_type_sped", "integer", "1 if the school is special education, -1 otherwise",
  "district_type_regular", "integer", "1 if district is regular local, -1 otherwise",
  "district_type_charter", "integer", "1 if district is independent charter, -1 otherwise",
  "district_type_gov_run", "integer", "1 if district is a government-run agency, -1 otherwise",
  "status_open", "integer", "1 if the school is open at start of year, -1 otherwise",
  "status_new", "integer", "1 if the school is newly opened, -1 otherwise",
  "status_moved", "integer", "1 if the school changed boundary/agency, -1 otherwise",
  "status_reopened", "integer", "1 if the school was reopened, -1 otherwise",
  "school_level_ms", "integer", "1 if the school serves middle school level, -1 otherwise",
  "school_level_es", "integer", "1 if the school serves elementary school level, -1 otherwise",
  "school_level_hs", "integer", "1 if the school serves high school level, -1 otherwise",
  "race_aian", "numeric", "Share of students identifying as American Indian/Alaska Native",
  "race_aapi", "numeric", "Share of students identifying as Asian or Pacific Islander",
  "race_hispanic", "numeric", "Share of students identifying as Hispanic",
  "race_black", "numeric", "Share of students identifying as Black or African American",
  "race_white", "numeric", "Share of students identifying as White",
  "race_nhpi", "numeric", "Share of students identifying as Native Hawaiian/Pacific Islander",
  "race_multi", "numeric", "Share of students identifying as two or more races",
  "gender_male", "numeric", "Share of students identifying as male",
  "gender_female", "numeric", "Share of students identifying as female"
)


for (i in seq_len(nrow(column_info))) {
  cat(
    paste0(
      "Column:      ", column_info$Column[i], " [", column_info$Type[i], "]", "\n",
      "Description: ", column_info$Description[i], "\n",
      "-------------------------------------------\n"
    )
  )
}
```

## Investigate the data

The number of schools with data in each school year over the 10 years of the dataset are relatively steady at around 86-thousand schools in roughly 16-thousand districts per year.

```{r methods-investigate-data, echo = FALSE, warning = FALSE}
#schools by year
schools_by_year = ed_data_full %>%
  group_by(year) %>%
  summarize(n = n())

schools_by_year %>%
  ggplot(aes(x = year, y = n)) +
  geom_col(fill = "#2c7fb8") +  # clean blue tone
  geom_text(
    aes(label = comma(n)), 
    vjust = -0.3, 
    color = "black",
    size = 3.5
  ) +
  scale_x_continuous(breaks = pretty(schools_by_year$year, n = 10)) +
  scale_y_continuous(label = comma) +
  labs(
    title = "Number of Schools in Dataset by Year",
    x = "Year",
    y = "Number of Schools"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

n_districts_avg = ed_data_full %>%
  select(district_id, year) %>%
  distinct() %>%
  group_by(year) %>%
  summarize(n = n()) %>%
  pull(n) %>%
  mean()

# Calculate geometric mean (exclude zeros and NAs)
enrollment_geo_mean = exp(mean(log(ed_data_full$total_students_all_grades[ed_data_full$total_students_all_grades > 0]), na.rm = TRUE))

# Plot with geometric mean
ed_data_full %>%
  ggplot(aes(x = total_students_all_grades)) +
  geom_histogram(fill = "#2c7fb8", bins = 30) +
  geom_vline(xintercept = enrollment_geo_mean, color = "black", linetype = "dashed", size = 1) +
  geom_text(
    aes(x = enrollment_geo_mean, y = 150000, label = paste0("Geo. Mean: ", comma(round(enrollment_geo_mean)))),
    vjust = -0.5,
    hjust = 0,
    color = "black",
    size = 4,
    inherit.aes = FALSE
  ) +
  scale_x_log10(labels = comma) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Student Enrollment Across all Schools",
    x = "Student Enrollment (log scale)",
    y = "Number of Schools"
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor = element_blank()
  )

# Racial trends over time
ed_data_full %>%
  group_by(year) %>%
  summarize(across(starts_with("race_"), ~mean(.x, na.rm = TRUE))) %>%
  pivot_longer(-year, names_to = "race", values_to = "share") %>%
  ggplot(aes(x = year, y = share, color = race)) +
  geom_line(size = 1.2) +
  labs(title = "Average Racial Composition of Schools Over Time",
       x = "Year", y = "Average Share", color = "Race") +
  scale_y_continuous(labels = percent) +
  theme_minimal()

#Explore missing data
library(naniar)
gg_miss_var(ed_data_full, show_pct = TRUE)
cat("Magnet School data is spotty, and is thus dropped.")
```

# III. Results
We begin by investigating trends in the top three races across schools and Title I funding, and slimmed down the dataset to focus on those parameters by...
This left us with.... of data, and removed all schools after 2022 since they are missing title I data
and added a scaled year with the midpoints being

The proportion of both Black and Hispanic students declined more often in Title I schools than non Title I schools, while the trend was reversed for White students.

To measure the trend, we first defined the change in % of race as...

We defined the title_i status of a school during the change period as ...

```{r results-prelim-visualization, warning = FALSE}
#Slim full dataset to just Title I and top 3 races
ed_data = ed_data_full %>%
  select(school_name, state, full_id, district_id, year, district_name, 
         county_name, county_number, total_students_all_grades, title_i, 
         race_hispanic, race_black, race_white) %>%
  mutate(
    title_i = case_when(
      is.na(title_i) ~ NA,
      title_i ~ 1,
      !title_i ~ 0
      ),
    year_scaled = year - 2015
    ) %>%
  filter(!is.na(title_i), !is.na(race_hispanic), !is.na(race_black), !is.na(race_white)) %>%
  #remove schools with only 1 year of data
  group_by(full_id) %>%
  filter(n() >= 2) %>%
  ungroup()

#Racial Trends of top three races in public schools
ed_data %>%
  group_by(year) %>%
  summarize(across(starts_with("race_"), ~mean(.x, na.rm = TRUE))) %>%
  pivot_longer(-year, names_to = "race", values_to = "share") %>%
  ggplot(aes(x = year, y = share, color = race)) +
  geom_line(size = 1.2) +
  labs(title = "Average Racial Composition of Schools Over Time",
       x = "Year", y = "Average Share", color = "Race") +
  scale_y_continuous(labels = percent) +
  theme_minimal()

#Create race trend set for preliminary visualization
race_trends = ed_data %>%
  group_by(full_id) %>%
  summarize(
    first_year = min(year),
    last_year = max(year),
    race_black_change = race_black[year == last_year] - race_black[year == first_year],
    race_hispanic_change = race_hispanic[year == last_year] - race_hispanic[year == first_year],
    race_white_change = race_white[year == last_year] - race_white[year == first_year],
    avg_enrollment = mean(total_students_all_grades),
    title_i_mode = as.numeric(names(which.max(table(title_i))))
  ) %>%
  filter(last_year > 2020, first_year < 2016) %>%
  select(race_black_change, race_hispanic_change, race_white_change, title_i_mode, avg_enrollment)

#Title I schools appear to be more likely to have lost black students proportionally in the last 10 years
race_trends %>%
  ggplot(aes(x = race_black_change, fill = title_i_mode == 1)) +
  geom_density(alpha = 0.4) +
  scale_fill_manual(values = c("FALSE" = "#e41a1c", "TRUE" = "#377eb8")) +
  scale_x_continuous(
    labels = percent_format(accuracy = 1),
    limits = .2 * c(-1, 1)
    ) +
  labs(
    title = "Distribution of Black Student Share Change",
    subtitle = "Comparing Title I vs. Non–Title I Schools",
    x = "Change in % Black Students",
    y = "Density",
    fill = "Title I"
  ) +
  theme_minimal(base_size = 12)

#Title I schools appear to be more likely to have lost hispanic students proportionally in the last 10 years
race_trends %>%
  ggplot(aes(x = race_hispanic_change, fill = title_i_mode == 1)) +
  geom_density(alpha = 0.4) +
  scale_fill_manual(values = c("FALSE" = "#e41a1c", "TRUE" = "#377eb8")) +
  scale_x_continuous(
    labels = percent_format(accuracy = 1),
    limits = .2 * c(-1, 1)
    ) +
  labs(
    title = "Distribution of Hispanic Student Share Change",
    subtitle = "Comparing Title I vs. Non–Title I Schools",
    x = "Change in % Hispanic Students",
    y = "Density",
    fill = "Title I"
  ) +
  theme_minimal(base_size = 12)

#Title I schools appear to be more likely to have lost hispanic students proportionally in the last 10 years
race_trends %>%
  ggplot(aes(x = race_white_change, fill = title_i_mode == 1)) +
  geom_density(alpha = 0.4) +
  scale_fill_manual(values = c("FALSE" = "#e41a1c", "TRUE" = "#377eb8")) +
  scale_x_continuous(
    labels = percent_format(accuracy = 1),
    limits = .3 * c(-1, 1)
    ) +
  labs(
    title = "Distribution of White Student Share Change",
    subtitle = "Comparing Title I vs. Non–Title I Schools",
    x = "Change in % White Students",
    y = "Density",
    fill = "Title I"
  ) +
  theme_minimal(base_size = 12)

```

Upon investigating the trends between Title I funding and race demographics, we found a statistically significant correlation between title_i status of a school and 

```{r results-models}
# Investigate with Linear Regression
lm_black = lm(race_black_change ~ title_i_mode + avg_enrollment, data = race_trends)
lm_hispanic = lm(race_hispanic_change ~ title_i_mode + avg_enrollment, data = race_trends)
lm_white = lm(race_white_change ~ title_i_mode + avg_enrollment, data = race_trends)

summary(lm_black)
summary(lm_hispanic)
summary(lm_white)

#Investigate with Liner Mixed-Effects Model
# Is the portion of black students changing faster in Title I schools changing faster over time?
lmer_black_state = lmer(race_black ~ title_i * year_scaled + (1 | full_id) + (1 | state), data = ed_data)
lmer_hispanic_state = lmer(race_hispanic ~ title_i * year_scaled + (1 | full_id) + (1 | state), data = ed_data)
lmer_white_state = lmer(race_white ~ title_i * year_scaled + (1 | full_id) + (1 | state), data = ed_data)


# Could not converge for black or white.
# Try without state as fix effect, since school_id already accounts for location
lmer_black = lmer(race_black ~ title_i * year_scaled + (1 | full_id), data = ed_data)
lmer_hispanic = lmer(race_hispanic ~ title_i * year_scaled + (1 | full_id), data = ed_data)
lmer_white = lmer(race_white ~ title_i * year_scaled + (1 | full_id), data = ed_data)


get_lmer_summary = function (model, race) {
  tidy(model, effects = "fixed") %>%
    select(term, estimate, std.error, statistic) %>%
    rename_with(~ paste0(race, "_", .), -term)
}

black_summary <- get_lmer_summary(lmer_black, "black")
white_summary <- get_lmer_summary(lmer_white, "white")
hispanic_summary <- get_lmer_summary(lmer_hispanic, "hispanic")

# Combine into one table
combined_summary <- reduce(
  list(black_summary, white_summary, hispanic_summary),
  full_join,
  by = "term"
  ) %>%
  mutate(
    black = sprintf("%.5f (%.5f) [%.2f]", black_estimate, black_std.error, black_statistic),
    white = sprintf("%.5f (%.5f) [%.2f]", white_estimate, white_std.error, white_statistic),
    hispanic = sprintf("%.5f (%.5f) [%.2f]", hispanic_estimate, hispanic_std.error, hispanic_statistic)
    ) %>%
  select(term, black, white, hispanic)

# Trends show that while title i schools are losing black and Hispanic students 
# and gaining white students, Non-Title I schools are diversifying
# NOTE: |t| > 2 ~ significant on the 5% level ()
suppressWarnings(
  combined_summary %>%
  kable(
    caption = "Fixed Effects Estimates (Standard Error) [t-values]",
    col.names = c("Predictor", "% Black", "% White", "% Hispanic")
  ) %>%
  kable_styling(full_width = FALSE)
)

```

## Predicting
The `lmer` model proved too memory-intensive to reliably generate predictions. As a fallback, we used a simpler linear regression model (`lm`) to estimate trends.

These generated predictions did not align well with the actual observed values.

```{r results-predict}
library(lme4)
library(tidyverse)
library(boot)

# Prediction grid: observed years, Title I only
years_observed <- sort(unique(ed_data$year_scaled))
pred_grid <- expand.grid(
  year_scaled = years_observed,
  title_i = 1
)

# Add year column for later
pred_grid$year <- pred_grid$year_scaled + 2015

# Function to predict fixed effects
predict_fixed <- function(model, newdata) {
  predict(model, newdata = newdata, re.form = NA)
}

# Wrapper to return matrix of predictions for bootstrapping
bootstrap_preds <- function(fit, newdata) {
  function(.) predict(fit, newdata = newdata, re.form = NA)
}

# Helper to bootstrap and extract mean + CI
get_bootstrap_ci <- function(model, pred_data) {
  boot_out <- bootMer(model, bootstrap_preds(model, pred_data),
                      nsim = 200, use.u = FALSE, re.form = NA, parallel = "no")
  
  preds <- predict(model, newdata = pred_data, re.form = NA)
  ci <- apply(boot_out$t, 2, quantile, probs = c(0.025, 0.975))

  tibble(
    predicted = preds,
    conf.low = ci[1, ],
    conf.high = ci[2, ]
  )
}

# Get predictions for each model
ci_black <- get_bootstrap_ci(lmer_black, pred_grid) %>%
  mutate(race = "Black")
ci_white <- get_bootstrap_ci(lmer_white, pred_grid) %>%
  mutate(race = "White")
ci_hispanic <- get_bootstrap_ci(lmer_hispanic, pred_grid) %>%
  mutate(race = "Hispanic")

# Combine results
pred_all <- bind_rows(ci_black, ci_white, ci_hispanic) %>%
  bind_cols(pred_grid[rep(1:nrow(pred_grid), times = 3), c("year", "year_scaled")])

# Prepare actual data summaries for Title I schools
actual_data <- ed_data %>%
  filter(title_i == 1) %>%
  group_by(year_scaled) %>%
  summarize(
    year = unique(year_scaled + 2015),
    Black = mean(race_black, na.rm = TRUE),
    White = mean(race_white, na.rm = TRUE),
    Hispanic = mean(race_hispanic, na.rm = TRUE)
  ) %>%
  pivot_longer(cols = c("Black", "White", "Hispanic"), names_to = "race", values_to = "actual")

# Join actual values to predictions for plotting
plot_data <- pred_all %>%
  left_join(actual_data, by = c("year", "race"))

# Final plot
ggplot(plot_data, aes(x = year)) +
  geom_line(aes(y = predicted, color = race), size = 1.2) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = race), alpha = 0.2, color = NA) +
  geom_point(aes(y = actual, color = race), size = 2, shape = 21, stroke = 0.5, fill = "white") +
  labs(
    title = "Predicted vs Actual Racial Composition in Title I Schools",
    y = "% of Students",
    x = "Year"
  ) +
  scale_y_continuous(labels = percent_format(scale = 100)) +
  theme_minimal() +
  theme(legend.position = "top")



```

# IV. Conclusion

The unreliable prediction results from the linear regression model suggests that while the overall trends may be statistically significant, the linear model lacks the complexity to capture meaningful patterns at the prediction level. More sophisticated approaches — or a richer dataset — may be required to generate reliable forecasts.

Despite those shortcomings, we discovered a surprising trend. Though small, there is indeed a statistically significant trend that **Title I** schools are **losing Black and Hispanic** shares over time more quickly (or gaining them more slowly) than **non–Title I** schools. Conversely, **White** student share is **decreasing** less rapidly in **Title I** schools than in **non–Title I** schools.

There is a clear trend across schools that as the American population grows more diverse, the portion of white students in schools decreases. The nuance of these results is that 