---
title: "Title I and Racial Demographic Shifts in U.S. Public Schools"
subtitle: "HarvardX PH125.9x Capstone Project - Part 2"
author: "Elan Weingarten"
date: "`r Sys.Date()`"
output:
  pdf_document:
    latex_engine: xelatex
    toc: true
    number_sections: true
---

# Introduction

**Topic:** Are Title I schools more likely to see increases in % White students and decreases in % Black or Hispanic students?

This study investigates whether Title I status is associated with different patterns of racial demographic change at the school level over time. Specifically, we analyze whether Title I schools are disproportionately likely to experience decreases in the percentage of Black and Hispanic students and increases in the percentage of White students.

Using both linear and mixed-effects regression models, we aim to capture and predict these trends in racial composition. Our goal is to inform education policy and the public as a whole by patterns in how financial-equity driven funding in public schools is related to the demographic shifts occurring in individual schools.

**Background**

Title I funding is a provision of the Elementary and Secondary Education Act that gives federal funds to schools with high percentages of students from low-income families. It is widely used as a proxy for school socioeconomic disadvantage. Whether or not a school has a Title I program is based its students' families economic need, and thus analyzing demographic shifts within Title I schools offers insights into broader trends of racial and socioeconomic changes and related government support (NCES Fast Facts: Title I).

Race is used in this analysis because of its centrality to historical and contemporary educational inequities, as well as its importance to the efficacy of school educators (Dee, 2004). Understanding racial composition trends in schools is essential for evaluating the effectiveness of educational policy and to inform future choices regarding public school policy and funding.

---

# Methods

## Overview

We gathered data from the **National Center for Education Statistics (NCES)** using their **Elementary and Secondary Information System (ELSi)** web tool. Using ELSi, we created and downloaded custom tables containing yearly school-level data, including total enrollment, Title I status, and racial composition among many other variables.

Each row in the dataset represents a single school in a single school year.

To prepare the data for analysis:

- Race and gender counts were transformed into percentages of total enrollment.
- Binary markers (e.g., Title I status, charter school designation) were expanded into columns coded as 1 (yes) or -1 (no).
- School years were normalized to a single year format: for instance, the 2023–2024 school year was labeled as 2024.

We removed data rows from the following:

- **Schools with fewer than 50 students:** These schools represent statistical outliers and may produce unstable estimates due to small sample sizes.
- **Schools missing demographic or Title I data.**
- **Schools with only 1 year of data**

The cleaned dataset included approximately 837,000 rows and 36 columns, representing 93,729 unique schools across 16,954 in all 50 states and the District of Columbia.

Of these, approximately 537,000 had complete data on both racial demographics and Title I status.

## Modeling Approach

Our analysis followed the following structure:

 1. Load, clean, and process the dataset
 2. Exploratory data analysis
 3. Attempt basic linear regression model
 4. Refine the model using mixed-effects models
 5. Attempt to make predictions using the mixed-effects models
 6. Explain the trends

```{r setup, include = FALSE}
library(broom.mixed)
library(caret)
library(knitr)
library(kableExtra)
library(lme4)
library(naniar)
library(scales)
library(tidyverse)
library(patchwork)

if (!file.exists(file.path("data", "r_variables.RData"))) {
  stop("Required file 'data/r_variables.RData' not found. Please run the .R script first to generate it.")
}
```

## Load, clean, and process the dataset

```{r methods-clean-data, message = FALSE, warning = FALSE}
# Load data generated by the .R script `Capstone - Education Data Weingarten.R`
load(file.path("data", "r_variables.RData"))

kable(
  as.data.frame(t(dim(ed_data_full))) %>%
    `colnames<-`(c("Rows", "Columns")),
  caption = "Clean data was created from NCES dataset with the following dimensions"
)
```

## Exploratory Data Analysis

### Counts of schools, districts, and students

```{r methods-investigate-data, echo = FALSE, warning = FALSE, results = "asis"}

enrollment_geo_mean = exp(mean(log(ed_data_full$total_students_all_grades[ed_data_full$total_students_all_grades > 0]), na.rm = TRUE))

cat("The full dataset contains on average roughly", comma(n_districts_avg, accuracy = 100),
    "districts and", comma(n_schools_avg, accuracy = 100), "schools per each
    year of data.\n\n")

cat("Enrollment across schools is normally distributed (on the logarithmic scale) as to be expected with population sizes. The typical school has", round(enrollment_geo_mean, 0), "students (geometric mean).\n\n")

```

```{r, fig.width=7, fig.height=10, echo=FALSE, warning = FALSE}

schools_by_year_plot / enrollment_plot
```

### Student racial trends
There is no racial data for 2017, but otherwise a clear trend is shown for all groups from 2015 to 2024:

* White is largest group, decreasing steadily.
* Hispanic is second most common group, increasing faster than any other group.
* Black is the third most common group, fluctuating, but steady over all.

All other racial groups form a small minority compared to these three.

```{r methods-race-plot, echo = FALSE, warning = FALSE} 
race_trends_plot

```

### Explore missing data

We found that data about the status of a school being a Magnet School data is missing more than 80% of the time, and was thus dropped.

```{r methods-explore-missing-data, echo = FALSE, warning = FALSE}

gg_miss_var(ed_data_full, show_pct = TRUE)

```

### Refocus the dataset
Based on patterns observed during exploratory data analysis, we chose to focus on racial demographic trends in relation to whether or not a school was implementing a Title I program (a proxy for the school educating many students from low-income families). Because income equity efforts can intersect with racial equity concerns, this analysis explores whether Title I schools exhibit different racial trends over time.

To keep the analysis both meaningful and manageable, we focused on the three largest racial groups in the dataset: White, Hispanic, and Black.

### Explore racial trends of the top three most populous races
When we focused on these three races, we found that the trend for all races seem to have shifted around the time COVID was having the biggest impact in schools: 2020~2021. Noticing that complication, we chose to investigate whether general trends were still meaningful related to race changes over the years.

```{r methods-explore-3-race, echo = FALSE, warning = FALSE}

race3_trend_plot

```

### Explore trends in **changes** in racial shares over the years
We calculated the change in racial shares by measuring the share of that race for the school's first year in the dataset, and then in its last year of the dataset. By subtracting the last year from the first year's race share, we found the change in racial share.

By plotting the density curves of each change in racial share for both Title I and non-Title I schools we found that:

* Title I schools appear to be **more** likely to have lost Black students proportionally in the last 10 years
* Title I schools appear to be **more** likely to have lost Hispanic students proportionally in the last 10 years, more so than Black students.
* Title I schools appear to be **LESS** likely to have lost White students than non-Title I schools in the last 10 years.

```{r, fig.width=7, fig.height=10, echo=FALSE, warning=FALSE}

black_density_plot / hispanic_density_plot / white_density_plot

```

# Results

In our exploratory analysis we found an apparent, and surprising, relationship between racial composition and Title I status. To investigate this trend more rigorously, we applied regression modeling techniques to quantify and test these patterns.

## Linear regression model

We began by fitting a basic linear regression model using the `lm()` function. This model aimed to describe and predict the **change in racial composition** (i.e., year-over-year change in % Black, % Hispanic, and % White students) at the school level in relation to Title I status.

Two predictor variables were used:

- **`title_i_mode`**: the most frequent Title I status of a school across the years of data available (0 or 1)
- **`avg_enrollment`**: the school’s average enrollment across those years

The results in the table 2, above, show the effect of these two predictor variables on the racial share for each of the three racial groups. It also presents the **standard errors** (in parentheses) and **t-values** (in brackets).

A |t-value| greater than 2 indicates statistical significance at the 95% confidence level. In this model, the Title I coefficient for Hispanic student change is not statistically significant, as its t-value is below this threshold, but all other coefficients were found to be statistically significant.

*Note that for this model, the 2014-15 school year was defined as 'year 0', thus the intercept refers to 2015.*

```{r results-simple-lm}
lm_black = lm(race_black_change ~ title_i_mode + avg_enrollment, 
              data = race_trends)
lm_hispanic = lm(race_hispanic_change ~ title_i_mode + avg_enrollment,
                 data = race_trends)
lm_white = lm(race_white_change ~ title_i_mode + avg_enrollment,
              data = race_trends)
```

```{r results-simple-lm-summary, echo = FALSE, warning = FALSE}
lm_summary %>%
  kable(format = "latex", booktabs = TRUE,
        caption = "Linear Regression Estimates (Standard Error) [t-values]",
        col.names = c("Predictor", "% Black", "% White", "% Hispanic"))

```

## Refine the model using mixed-effects regression

Because we found a significant correlation between most of our independent variables and race changes, we investigated a more robust model using Mixed Effect linear regression and the `lmer` function. This models the school (`full_id`) and state as random effects to control for unobserved, school- or state-specific characteristics.

Our first attempt controlling for both the school and the state failed, as the model could not converge for the model for Black or White students. Thus, we tried again, with only the school (`full_id`) as a random effect, since the school already accounted for location and including state was somewhat redundant.

Unlike the earlier model that predicted year-over-year *change*, these models analyze **absolute racial composition** by year, enabling a more precise and stable estimation.

The results below show mixed-effect estimates, along with the standard error (in parentheses) and the t-values (in brackets). Trends show that while Title I schools are losing black and Hispanic students and gaining white students, Non-Title I schools are diversifying

All trends with Mixed Effect model are highly statistically significant given the high t-statistic value. Because they are such robust trends, the small magnitudes (ranging from 0.001% to 0.02% shifts in racial share per year/Title I status change) of the effects are not negligible. While these impacts may be small over one or two years at an individual school, when thousands or millions or students on a district or state level are considered, these effects can represent many students.

```{r results-lmer}
# lmer_black_state = lmer(race_black ~ title_i * year_scaled + 
#                           (1 | full_id) + (1 | state), data = ed_data)
# lmer_hispanic_state = lmer(race_hispanic ~ title_i * year_scaled + 
#                              (1 | full_id) + (1 | state), data = ed_data)
# lmer_white_state = lmer(race_white ~ title_i * year_scaled + 
#                           (1 | full_id) + (1 | state), data = ed_data)
# 
# # Error! Model could not converge for black or white.

lmer_black = lmer(race_black ~ title_i * year_scaled + 
                    (1 | full_id), data = ed_data)
lmer_hispanic = lmer(race_hispanic ~ title_i * year_scaled + 
                       (1 | full_id), data = ed_data)
lmer_white = lmer(race_white ~ title_i * year_scaled + 
                    (1 | full_id), data = ed_data)

```

```{r results-lmer-summary, echo = FALSE, warning = FALSE}
lmer_summary %>%
  kable(format = "latex", booktabs = TRUE,
        caption = "Fixed Effects Estimates (Standard Error) [t-values]",
        col.names = c("Predictor", "% Black", "% White", "% Hispanic"))

```

## Attempt to make predictions using the mixed-effects models

The `lmer` model proved too memory-intensive to reliably generate predictions. As a fallback, we used a simpler linear regression model (`lm`) to estimate trends.

We conducted this test by splitting the data in a training (80%) and test (20%) set. We trained the linear regression model on the training set and predicted values for the test set, computing a Root Mean Square Error (RMSE) to determine the accuracy of the model's predictions.

Although the model is trained with highly precise estimates, the RMSE ended up being far to close to the order of magnitude of the demographic percentages (10~50%) that we were already looking at.

```{r results-predict}
set.seed(42)  # for reproducibility

# Split ed_data into train (80%) and test (20%)
train_indices <- sample(nrow(ed_data), size = 0.8 * nrow(ed_data))
ed_train <- ed_data[train_indices, ]
ed_test <- ed_data[-train_indices, ]

# Train simpler lm model
simple_lm_black = lm(race_black ~ title_i * year_scaled, data = ed_train)
simple_lm_hispanic = lm(race_hispanic ~ title_i * year_scaled, data = ed_train)
simple_lm_white = lm(race_white ~ title_i * year_scaled, data = ed_train)

# Predict on test data
ed_test = ed_test %>%
  mutate(
    pred_black = predict(simple_lm_black, newdata = ed_test),
    pred_white = predict(simple_lm_white, newdata = ed_test),
    pred_hispanic = predict(simple_lm_hispanic, newdata = ed_test)
  )

# Calculate RMSE
rmse_black = RMSE(ed_test$pred_black, ed_test$race_black)
rmse_white = RMSE(ed_test$pred_white, ed_test$race_white)
rmse_hispanic = RMSE(ed_test$pred_hispanic, ed_test$race_hispanic)

# Print results
kable(
  data.frame(
    Race = c("Black", "White", "Hispanic"),
    RMSE = c(rmse_black, rmse_white, rmse_hispanic)
  ),
  digits = 3,
  caption = "Root Mean Squared Error (RMSE) by Race",
  col.names = c("Race", "RMSE")
)


```

# Conclusion
The unreliable prediction results from the linear regression model suggests that while the overall trends may be statistically significant, the linear model lacks the complexity to capture meaningful patterns at the prediction level. More sophisticated approaches — or a richer dataset — may be required to generate reliable forecasts.

Despite those shortcomings, we discovered a surprising trend. Though small, there is indeed a statistically significant trend that **Title I** schools are **losing Black and Hispanic** shares over time more quickly (or gaining them more slowly) than **non–Title I** schools. Conversely, **White** student share is **decreasing** less rapidly in **Title I** schools than in **non–Title I** schools.

There is a clear trend across schools that as the American population grows more diverse, the portion of white students in schools decreases. Some interesting implications of this include bucking a trending idea that it is only poor students of color who benefit from Title I funding or other financial assistance. In fact, despite the trend that white students are decreasingly the majority in public schools, they are proportionally being more represented in schools with Title I programs when compared to their Black and Hispanic counterparts. This may be due economic changes among different races, or in the way that Title I programs are being implemented.

To further understand the trends we are seeing, a more robust modeling approach—beyond linear and mixed-effects regression—would be needed, and other variables would need to be included to control for more variation. However, this report serves as a strong motivating first step in looking further into this trend and understanding what may be driving it, and what the implications may be. With those things understood, perhaps a better predictive model could be created that could aid schools in predicting their racial and economic demographics.

# References & Acknowledgments
- National Center for Education Statistics (NCES) Elementary/Secondary Information System (ELSi). [https://nces.ed.gov/ccd/elsi/](https://nces.ed.gov/ccd/elsi/)

- NCES Fast Facts: Title I [https://nces.ed.gov/fastfacts/display.asp?id=158](https://nces.ed.gov/fastfacts/display.asp?id=158)

- Dee, Thomas. (2004). Teachers, Race, and Student Achievement in a Randomized Experiment. The Review of Economics and Statistics. 86. 195-210. 10.1162/003465304323023750. 

- Open AI's ChatGPT for code optimization